<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title> CoolVoce ❤️💚</title>
  <style>
    /* (stili come prima — rimossi qui per brevità nella visuale, mantieni gli stili che usavi) */
    :root { --green:#00b25c; --red:#b30000; --muted-border:#dcdcdc; --bg-start:#fff8f8; --bg-end:#f3fff3; --text:#222; --card-bg:#fff; --highlight-bg:#f7fff7; --link-bg:#f9fff9; --button-gradient:linear-gradient(90deg,var(--green),var(--red)); }
    body.dark { --green:#00e676; --red:#ff5252; --muted-border:#333; --bg-start:#121212; --bg-end:#1b1b1b; --text:#f5f5f5; --card-bg:#1e1e1e; --highlight-bg:#222; --link-bg:#161616; --button-gradient:linear-gradient(90deg,var(--green),var(--red)); }
    html{min-height:100%;box-sizing:border-box}*,*::before,*::after{box-sizing:inherit}body{min-height:100%;margin:0;font-family:'Segoe UI',system-ui,-apple-system,"Helvetica Neue",Arial;background:linear-gradient(135deg,var(--bg-start),var(--bg-end));color:var(--text);-webkit-font-smoothing:antialiased;transition:background .4s ease,color .4s ease}
    /* ... mantieni tutti gli stili originali ... */
  </style>
</head>
<body class="dark">
  <div class="theme-toggle" id="themeToggle" title="Cambia tema">
    <span class="moon">🌙</span>
    <span class="sun">☀️</span>
  </div>

  <div class="container" role="main">
    <div class="logo">
      <div class="logo-shape"{
  "EVO20_MNPANN": {
    "label": "€2.49 EVO20 ANN",
    "desc": "📱 MIN ILL, 1000 SMS e 20GB<br>💰 29.90€ 1° ANNO, poi 4.90€/mese | ATTIVAZIONE FREE<br>📅 SCADENZA: 12/2024"
  },
  "EVO50_MNPGRT2": {
    "label": "€4.90 EVO50",
    "desc": "📱 MIN ILL, 1000 SMS e 50GB<br>💰 4.90€/mese | NESSUN COSTO<br>📆 SCADENZA: 12/2024"
  },
  "EVO100_MNP4": {
    "label": "€5.50 EVO100",
    "desc": "📱 MIN ILL, 1000 SMS e 100GB<br>💰 5.50€/mese | ATTIVAZIONE FREE<br>📆 SCADENZA: 22/10/2025"
  },
  "EVO150_MNPGRT5": {
    "label": "€6.90 EVO150",
    "desc": "📱 MIN ILL, 1000 SMS e 150GB<br>💰 6.90€/mese | NESSUN COSTO<br>📅 SCADENZA: 07/2025"
  },
  "EVO200_MNPGRT7": {
    "label": "€7.90 EVO200",
    "desc": "📱 MIN ILL, 1000 SMS e 200GB<br>💰 7.90€/mese | NESSUN COSTO<br>📅 SCADENZA: 12/2024"
  },
  "EXT300MNPGRT5": {
    "label": "€7.90 EVO300",
    "desc": "📱 MIN ILL, 1000 SMS e 300GB<br>💰 7.90€/mese | ATTIVAZIONE FREE<br>📅 SCADENZA: 06/2025"
  },
  "EXT300MNPGRT4": {
    "label": "€9.90 EVO300",
    "desc": "📱 MIN ILL, 1000 SMS e 300GB<br>💰 9.90€/mese | NESSUN COSTO<br>📅 SCADENZA: 03/2025"
  },
  "EVOUNMNPATGRT": {
    "label": "€9.90 EVO UNLIMITED",
    "desc": "📱 MIN ILL, 1000 SMS e GB ILL (500GB) <br>💰 9.90€/mese | ATTIVAZIONE FREE<br>📅 SCADENZA: 11/2024"
  }
}></div>
      <div class="logo-text"> CoolVoce</div>
      <div class="hearts">❤️💚</div>
    </div>

    <div class="controls-grid">
      <div class="control">
        <label for="offerSelect">OFFERTA?</label>
        <select id="offerSelect" aria-describedby="offerDescription">
          <option value="">SELEZIONA</option>
        </select>
      </div>

      <div class="control">
        <label for="customOffer">PERSONALIZZATO?</label>
        <input id="customOffer" type="text" placeholder="CODICE OFFERTA" />
      </div>

      <div class="control">
        <label for="simType">SIM?</label>
        <select id="simType">
          <option value="SPEDIZIONE">SIM</option>
          <option value="ESIM">eSIM</option>
        </select>
      </div>

      <div class="control">
        <label for="activationType">ATTIVAZIONE?</label>
        <select id="activationType">
          <option value="1">NUOVA</option>
          <option value="2">MNP</option>
        </select>
      </div>

      <div class="generate-row">
        <button id="generateBtn" type="button">GENERA</button>
      </div>
    </div>

    <div id="offerDescription" class="offer-description" aria-live="polite" aria-atomic="true"></div>
    <div id="linksContainer"></div>
  </div>

  <!-- Carica il loader che popola window.CoolVoceOffers -->
  <script src="./js/offers-loader.js"></script>

  <script>
    // Il resto dello script rimane identico: ascolta l'evento 'offers:loaded' e init.
    (function(){
      const autoDetect = false;
      const themeToggle = document.getElementById('themeToggle');
      const body = document.body;

      const stored = localStorage.getItem('coolvoce-theme');
      if (stored === 'dark') body.classList.add('dark');
      else if (stored === 'light') body.classList.remove('dark');
      else if (autoDetect && window.matchMedia('(prefers-color-scheme: dark)').matches) body.classList.add('dark');

      themeToggle.addEventListener('click', () => {
        body.classList.toggle('dark');
        localStorage.setItem('coolvoce-theme', body.classList.contains('dark') ? 'dark' : 'light');
      });

      const qs = id => document.getElementById(id);
      const offerSelect = qs('offerSelect');
      const customInput = qs('customOffer');
      const simType = qs('simType');
      const activationType = qs('activationType');
      const generateBtn = qs('generateBtn');
      const offerDescription = qs('offerDescription');
      const linksContainer = qs('linksContainer');

      function makeId(s){ return String(s).replace(/[^a-zA-Z0-9\-_:.]/g, '-'); }
      function hideDescription(){ offerDescription.style.display='none'; offerDescription.innerHTML=''; offerDescription.removeAttribute('data-offer-key'); }

      function showOffer(key, offers){
        if (!key || !offers || !offers[key]) return hideDescription();
        const o = offers[key];
        const label = o.label || key;
        const desc = o.desc || '';
        const labelId = makeId('label-' + key);
        const descId = makeId('desc-' + key);
        function escapeHtml(str){ return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
        offerDescription.innerHTML = '<div class="offer-label" id="'+labelId+'" role="heading" aria-level="3">'+escapeHtml(label)+' <span class="offer-key" aria-hidden="true">('+escapeHtml(key)+')</span></div><div class="offer-desc" id="'+descId+'">'+desc+'</div>';
        offerDescription.style.display = 'block';
        offerDescription.setAttribute('data-offer-key', key);
      }

      function clearLatest(){ const p = linksContainer.querySelector('.link-box.latest'); if (p) p.classList.remove('latest'); }

      async function copyText(t){
        if (navigator.clipboard && navigator.clipboard.writeText) {
          try { await navigator.clipboard.writeText(t); return true; } catch(e) {}
        }
        try {
          const ta = document.createElement('textarea');
          ta.value = t;
          ta.style.position = 'fixed';
          ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          return true;
        } catch(e) { return false; }
      }

      function showTooltip(msg){
        const t = document.createElement('div');
        t.textContent = msg;
        t.style.position = 'fixed';
        t.style.bottom = '90px';
        t.style.left = '50%';
        t.style.transform = 'translateX(-50%)';
        t.style.background = 'rgba(179,0,0,0.9)';
        t.style.color = '#fff';
        t.style.padding = '10px 16px';
        t.style.borderRadius = '10px';
        t.style.fontWeight = '600';
        t.style.zIndex = '9999';
        t.style.opacity = '0';
        t.style.transition = 'opacity .3s ease';
        document.body.appendChild(t);
        requestAnimationFrame(() => t.style.opacity = '1');
        setTimeout(() => { t.style.opacity = '0'; setTimeout(()=> t.remove(),300); }, 1500);
      }

      function populateOfferSelect(offers) {
        offerSelect.innerHTML = '<option value="">SELEZIONA</option>';
        if (!offers || Object.keys(offers).length === 0) return;
        Object.keys(offers).forEach(key => {
          const opt = document.createElement('option');
          opt.value = key;
          opt.textContent = (offers[key] && offers[key].label) ? offers[key].label : key;
          offerSelect.appendChild(opt);
        });
      }

      function initWithOffers() {
        const offers = window.CoolVoceOffers || {};
        populateOfferSelect(offers);

        offerSelect.addEventListener('change', () => {
          const sel = offerSelect.value;
          if (sel) {
            customInput.value = '';
            if (offers[sel]) showOffer(sel, offers);
            else hideDescription();
          } else hideDescription();
        });

        customInput.addEventListener('input', () => {
          const v = customInput.value.trim();
          if (v) {
            if (offerSelect.value !== '') offerSelect.value = '';
            hideDescription();
          } else {
            const sel = offerSelect.value;
            if (sel && offers[sel]) showOffer(sel, offers);
          }
        });

        generateBtn.addEventListener('click', async () => {
          const custom = customInput.value.trim();
          const selected = offerSelect.value.trim();
          const offerCode = (custom !== '' ? custom : selected);

          customInput.style.boxShadow = '0 4px 10px rgba(0,0,0,0.06)';
          offerSelect.style.boxShadow = '0 4px 10px rgba(0,0,0,0.06)';

          if (!offerCode) {
            customInput.style.boxShadow = '0 0 0 4px rgba(211,47,47,0.12)';
            offerSelect.style.boxShadow = '0 0 0 4px rgba(211,47,47,0.12)';
            showTooltip('IMPOSTA OFFERTA');
            setTimeout(() => {
              customInput.style.boxShadow = '0 4px 10px rgba(0,0,0,0.06)';
              offerSelect.style.boxShadow = '0 4px 10px rgba(0,0,0,0.06)';
            }, 700);
            return;
          }

          const tipoFlusso = simType.value;
          const tipoAttivazione = activationType.value;
          const prefix = tipoFlusso === 'ESIM' ? 'ES_' : '';
          const rawCode = prefix + offerCode;
          const link = `https://shop.coopvoce.it/?tipoFlusso=${encodeURIComponent(tipoFlusso)}&tipoAttivazione=${encodeURIComponent(tipoAttivazione)}&codiceCampagna=${encodeURIComponent(rawCode)}`;

          clearLatest();
          const box = document.createElement('div');
          box.className = 'link-box latest';
          box.innerHTML = `
            <div class="link-main"><a href="${link}" target="_blank">${link}</a></div>
            <div class="link-actions">
              <button class="open-btn" type="button">APRI</button>
              <button class="copy-btn" type="button">COPIA</button>
            </div>
          `;
          linksContainer.prepend(box);

          await copyText(link);

          generateBtn.classList.add('copied');
          generateBtn.textContent = 'COPIATO!';
          setTimeout(() => {
            generateBtn.classList.remove('copied');
            generateBtn.textContent = 'GENERA';
          }, 1400);

          const openBtn = box.querySelector('.open-btn');
          const copyBtn = box.querySelector('.copy-btn');
          openBtn.addEventListener('click', () => window.open(link, '_blank'));
          copyBtn.addEventListener('click', async () => {
            const ok = await copyText(link);
            const old = copyBtn.textContent;
            copyBtn.textContent = ok ? 'Copiato!' : 'Errore';
            setTimeout(() => copyBtn.textContent = old, 1200);
          });
        });
      }

      if (window.CoolVoceOffers && Object.keys(window.CoolVoceOffers).length > 0) {
        initWithOffers();
      } else {
        document.addEventListener('offers:loaded', function handler() {
          document.removeEventListener('offers:loaded', handler);
          initWithOffers();
        });
      }
    })();
  </script>
</body>
</html>
